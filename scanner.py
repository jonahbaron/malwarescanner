#!/usr/bin/env python

import sys
import subprocess
import os
from os import listdir
import argparse
from datetime import datetime

#read hashes from specified file and store them in a list
def getHashes(hashfile):
	with open(hashfile) as hfile:
		hashcontent = hfile.readlines()

	hashes = []

	for line in hashcontent:
		hashvalue = line.split(None, 1)[0]
		hashvalue = hashvalue.lower()
		hashes.append(hashvalue)

	return hashes

#directory walk the local directory (or specified directory) to identify and store the files in a list to "scan"
def getFiles(directory):
	files = []

	for path, subdirs, localfiles in os.walk(directory):
		for filename in localfiles:
			f = os.path.join(path, filename)
			files.append(f)
	return files

#compare the hashes from the hashes file to the hashes of the identified files and file's strings output
def checkHash(hashes,files):
	print "Scanning files"

	badFiles = []
#	for h in hashes:
#		print "Comparing files and file content against hash: ", h

	for f in files:
		print "Scanning: ", f

		command = "md5sum " + f + " | awk '{ print $1 }'"
		fileHash = subprocess.check_output(command, shell=True)
		fileHash = fileHash.rstrip()
		
		command = "strings " + f + " | md5sum | awk '{ print $1 }'"
		contentHash = subprocess.check_output(command, shell=True)
		contentHash = contentHash.rstrip()

		for h in hashes:
			#print "Checking against hash: ", h
			#if a hash matches the file as a whole, store the file location in a list to display later
			if h == fileHash or h == contentHash:
				print "\tMALICIOUS FILE DETECTED - ", f
				badFiles.append(f)

			#analyze each line of the file to check for malicious content, store file in list if a hash matches
			else:
				with open(f, 'rUb') as filecontent:
					filelines = filecontent.readlines()
				for line in filelines:
					with open('temp.txt', 'w') as tempfile:
						tempfile.write(line)
					command = "md5sum temp.txt | awk '{ print $1 }'"
					lineHash = subprocess.check_output(command, shell=True)
					lineHash = lineHash.rstrip()
					os.system("rm temp.txt")
					if h == lineHash:
						print "\tMALICIOUS CONTENT DETECTED - ", f
						badFiles.append(f)
	print ""
	return badFiles

def main():
	startTime = datetime.now()
	print "Malware scanner"
	print ""

	parser = argparse.ArgumentParser(description = "Scan for malicious files")
	parser.add_argument("hashfile", type=str, help="File containing a list of MD5 hashes from known malicious files")
	parser.add_argument("-d", "--directory", type=str, help="The directory to scan; the default scan directory is the local directory", default= os.getcwd())
	args = parser.parse_args()

	#set the hashes file and directory (if the user specificied a directory) variable locations
	hashfile = args.hashfile
	directory = args.directory

	hashes = getHashes(hashfile)

	#print the list of loaded hashes
	print "Hashes loaded"
	print len(hashes), " total"
	print "-----"
	for line in hashes:
		print line
	print ""

	files = getFiles(directory)

	#print the list of files identified
	print "Files identified"
	print len(files), " total"
	print "-----"
	for f in files:
		print f
	print ""

	badFiles = checkHash(hashes,files)
	badFiles = list(set(badFiles))

	#print the list of identified malicious files
	print "Malicious files"
	print len(badFiles), " total"
	print "-----"
	if len(badFiles) == 0:
		print "No malware found"
	for f in badFiles:
		print f
	print ""

	print "Time to run scan: ", datetime.now() - startTime

if __name__ == "__main__":
	main()
